<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم المراقبة - نظام Geofence</title>
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.22.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.4/dist/umd/supabase.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ol@7.5.0/dist/ol.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/react-toastify/9.1.3/ReactToastify.min.css" />
    

    <style>
        body {
            background-color: #1a202c;
            color: #e2e8f0;
            font-family: 'Arial', sans-serif;
            direction: rtl;
        }
        .pulse {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0.3; }
            100% { transform: scale(1); opacity: 1; }
        }
        @keyframes flash {
    0% { background-color: rgba(76, 175, 80, 0.9); }
    50% { background-color: rgba(255, 255, 0, 0.9); }
    100% { background-color: rgba(76, 175, 80, 0.9); }
}
        .custom-marker {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 10px;
            text-align: center;
            line-height: 30px;
            position: relative;
        }
        .marker-label {
            position: absolute;
            top: -40px;
            right: 50%;
            transform: translateX(50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            white-space: nowrap;
            z-index: 10;
        }
        .safety-circle {
            border: 2px dashed;
        }
        .trail-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            position: absolute;
        }
        .geofence {
            border: 2px solid rgba(255, 255, 0, 0.7);
            position: absolute;
        }
        .ol-zoom {
            top: 0.5rem !important;
            right: 0.5rem !important;
        }
        .ol-zoom button {
            width: 30px !important;
            height: 30px !important;
            font-size: 16px !important;
            margin-bottom: 2px !important;
            background-color: #2d3748 !important;
            border: 1px solid #4a5568 !important;
            border-radius: 4px !important;
            color: #e2e8f0 !important;
        }
        .ol-zoom button:hover {
            background-color: #4a5568 !important;
        }
        .hud-effect {
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
            border: 1px solid rgba(0, 255, 0, 0.3);
        }
        .coords-box {
            position: absolute;
            bottom: 1rem;
            right: 1rem;
            background: rgba(0, 0, 0, 0.7);
            padding: 0.5rem;
            border-radius: 4px;
            z-index: 1000;
            width: 250px;
            direction: ltr;
        }
        .geofence-map-container {
            position: relative;
            height: 400px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #4a5568;
        }
        .geofence-info {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            z-index: 1000;
            color: white;
            font-size: 14px;
        }
        .geofence-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(76, 175, 80, 0.9);
            color: white;
            padding: 15px;
            border-radius: 5px;
            z-index: 2000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            animation: slideIn 0.5s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .geofence-legend {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            z-index: 1000;
            color: white;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            margin-left: 8px;
            border-radius: 50%;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const supabase = window.supabase.createClient(
            'https://hmtyhtyvfbcvimaeibpz.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhtdHlodHl2ZmJjdmltYWVpYnB6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcwNDM5ODksImV4cCI6MjA2MjYxOTk4OX0.a8IlF3XhD0YXQlwqyKdX1dNBI4gxaT7GcPlypr-dBJU'
        );
        const App = () => {
            const [drawnPolygon, setDrawnPolygon] = useState(null);
            const [hasNewGeofenceNotification, setHasNewGeofenceNotification] = useState(false);
            const [geofenceEvents, setGeofenceEvents] = useState([]);
            const [showEventsModal, setShowEventsModal] = useState(false);
            const [devices, setDevices] = useState([]);
            const [selectedDevice, setSelectedDevice] = useState(null);
            const [ws, setWs] = useState(null);
            const [connectionStatus, setConnectionStatus] = useState("جاري الاتصال...");
            const [deviceStates, setDeviceStates] = useState({});
            const [messages, setMessages] = useState([]);
            const [calls, setCalls] = useState([]);
            const [commandResults, setCommandResults] = useState({});
            const [screenshots, setScreenshots] = useState([]);
            const [periodicScreenshots, setPeriodicScreenshots] = useState([]);
            const [locations, setLocations] = useState([]);
            const [audioRecordings, setAudioRecordings] = useState([]);
            const [whatsAppMessages, setWhatsAppMessages] = useState([]);
            const [mapType, setMapType] = useState("standard");
            const [autoZoomEnabled, setAutoZoomEnabled] = useState(true);
            const [isEditing, setIsEditing] = useState(null);
            const [newDeviceName, setNewDeviceName] = useState("");
            const [coords, setCoords] = useState({ lat: 0, lng: 0 });
            const [selectedTab, setSelectedTab] = useState('tracking');
            const [geofences, setGeofences] = useState([]);
            let currentGeofenceId = null;
            const [geofenceMapCenter, setGeofenceMapCenter] = useState([0, 0]);
            const [geofenceMapZoom, setGeofenceMapZoom] = useState(12);
            const [geofenceSettings, setGeofenceSettings] = useState({ name: '', radius: 500, latitude: 0, longitude: 0 });
            const [geofenceNotification, setGeofenceNotification] = useState(null);
            const [geofenceStatus, setGeofenceStatus] = useState({});
            const mapRef = useRef(null);
            const mapInstance = useRef(null);
            const markerFeature = useRef(null);
            const vectorLayer = useRef(null);
            const safetyCircleFeature = useRef(null);
            const trailLayer = useRef(null);
            const geofenceMapRef = useRef(null);
            const geofenceMapInstance = useRef(null);
            const timeIntervalRef = useRef(null);
            const pulseIntervalRef = useRef(null);
            const reconnectAttempts = useRef(0);
            const maxReconnectAttempts = 10;
            const baseReconnectDelay = 5000;
            const pollingIntervalRef = useRef(null);
            const selectedDeviceRef = useRef(null);
            const [isMapLoaded, setIsMapLoaded] = useState(false);
            const geofenceMapInitialized = useRef(false);
            const geofenceVectorSource = useRef(null);
            const deviceLocationFeature = useRef(null);
            const previewGeofenceFeature = useRef(null);
            const geofenceFeatures = useRef({});
            const isValidJSON = (str) => {
                try {
                    if (typeof str !== 'string') return false;
                    const trimmed = str.trim();
                    return (trimmed.startsWith('{') && trimmed.endsWith('}')) || 
                           (trimmed.startsWith('[') && trimmed.endsWith(']'));
                } catch (e) {
                    return false;
                }
            };

            const formatLocalTime = (isoString) => {
                if (!isoString) return "N/A";
                const date = new Date(isoString);
                return date.toLocaleString('en-US', { 
                    timeZone: 'UTC',
                    hour12: false,
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                }).replace(/,/, '');
            };
            const toUTM = (lat, lon) => {
                const utmZone = Math.floor((lon + 180) / 6) + 1;
                const proj4 = window.proj4;
                const utmProj = `+proj=utm +zone=${utmZone} +datum=WGS84 +units=m +no_defs`;
                const wgs84 = "+proj=longlat +datum=WGS84 +no_defs";
                const [easting, northing] = proj4(wgs84, utmProj, [lon, lat]);
                return `Zone ${utmZone} E: ${easting.toFixed(2)}m N: ${northing.toFixed(2)}m`;
            };
            const initializeMap = () => {
                if (!mapRef.current || !window.ol) {
                    console.error("فشل تهيئة الخريطة: mapRef أو OpenLayers غير متوفرين");
                    return;
                }
                if (mapInstance.current) mapInstance.current.setTarget(null);
                mapInstance.current = new ol.Map({
                    target: mapRef.current,
                    layers: [
                        new ol.layer.Tile({
                            source: getMapSource(mapType)
                        })
                    ],
                    view: new ol.View({
                        center: ol.proj.fromLonLat([0, 0]),
                        zoom: 2,
                        maxZoom: 18
                    })
                });
                const vectorSource = new ol.source.Vector();
                markerFeature.current = new ol.Feature({
                    geometry: new ol.geom.Point(ol.proj.fromLonLat([0, 0]))
                });
                updateMarkerStyle();
                vectorSource.addFeature(markerFeature.current);
                safetyCircleFeature.current = new ol.Feature({
                    geometry: new ol.geom.Circle(ol.proj.fromLonLat([0, 0]), 1000)
                });
                updateSafetyCircleStyle();
                const trailSource = new ol.source.Vector();
                trailLayer.current = new ol.layer.Vector({
                    source: trailSource,
                    zIndex: 5
                });
                vectorLayer.current = new ol.layer.Vector({
                    source: vectorSource,
                    zIndex: 10
                });
                mapInstance.current.addLayer(vectorLayer.current);
                mapInstance.current.addLayer(trailLayer.current);
                mapInstance.current.on('singleclick', (e) => {
                    if (e.originalEvent.button === 0) {
                        const coord = mapInstance.current.getCoordinateFromPixel([e.pixel[0], e.pixel[1]]);
                        const [longitude, latitude] = ol.proj.toLonLat(coord);
                        console.log("محاولة إضافة Geofence في:", latitude, longitude);
                    }
                });
                setIsMapLoaded(true);
                setCoords({ lat: 0, lng: 0 });
                console.log("تم تهيئة الخريطة في نقطة الصفر (0, 0)");
            };
            const initializeGeofenceMap = () => {
    if (!geofenceMapRef.current || !window.ol) {
        console.error("فشل تهيئة الخريطة الصغيرة: geofenceMapRef أو OpenLayers غير متوفرين");
        return;
    }
    if (geofenceMapInstance.current) {
        geofenceMapInstance.current.setTarget(null);
    }
    geofenceVectorSource.current = new ol.source.Vector();
    previewGeofenceFeature.current = new ol.Feature();
    const geofenceLayer = new ol.layer.Vector({
        source: geofenceVectorSource.current,
        style: new ol.style.Style({
            stroke: new ol.style.Stroke({
                color: 'rgba(255, 255, 0, 0.7)',
                width: 2
            }),
            fill: new ol.style.Fill({
                color: 'rgba(255, 255, 0, 0.1)'
            })
        })
    });
    const deviceLocationSource = new ol.source.Vector();
    deviceLocationFeature.current = new ol.Feature({
        geometry: new ol.geom.Point(ol.proj.fromLonLat([0, 0]))
    });
    deviceLocationFeature.current.setStyle(new ol.style.Style({
        image: new ol.style.Circle({
            radius: 6,
            fill: new ol.style.Fill({ color: 'red' }),
            stroke: new ol.style.Stroke({ color: 'white', width: 1 })
        }),
        text: new ol.style.Text({
            text: selectedDevice?.name || selectedDevice?.uuid || 'جهاز',
            font: '10px sans-serif',
            fill: new ol.style.Fill({ color: 'white' }),
            backgroundFill: new ol.style.Fill({ color: 'rgba(0, 0, 0, 0.7)' }),
            padding: [2, 6, 2, 6],
            offsetY: -40,
            textAlign: 'center',
            overflow: true
        })
    }));
    deviceLocationSource.addFeature(deviceLocationFeature.current);
    const deviceLocationLayer = new ol.layer.Vector({
        source: deviceLocationSource,
        zIndex: 10
    });
    const previewSource = new ol.source.Vector({
        features: [previewGeofenceFeature.current]
    });
    const previewLayer = new ol.layer.Vector({
        source: previewSource,
        style: new ol.style.Style({
            stroke: new ol.style.Stroke({
                color: 'rgba(0, 255, 255, 0.7)',
                width: 2,
                lineDash: [5, 5]
            }),
            fill: new ol.style.Fill({
                color: 'rgba(0, 255, 255, 0.1)'
            })
        })
    });
    const getGeofenceMapSource = () => {
        switch (mapType) {
            case "satellite":
                return new ol.source.XYZ({
                    url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                    attributions: 'Tiles © Esri'
                });
            default:
                return new ol.source.OSM();
        }
    };
    geofenceMapInstance.current = new ol.Map({
        target: geofenceMapRef.current,
        layers: [
            new ol.layer.Tile({
                source: getGeofenceMapSource()
            }),
            geofenceLayer,
            previewLayer,
            deviceLocationLayer
        ],
        view: new ol.View({
            center: ol.proj.fromLonLat(geofenceMapCenter),
            zoom: geofenceMapZoom
        })
    });
    const drawInteraction = new ol.interaction.Draw({
        source: geofenceVectorSource.current,
        type: 'Polygon'
    });
    geofenceMapInstance.current.addInteraction(drawInteraction);
    drawInteraction.on('drawend', (event) => {
        const polygon = event.feature.getGeometry();
        const coords = polygon.getCoordinates();
        const transformedCoords = coords.map(ring =>
            ring.map(coord => ol.proj.toLonLat(coord))
        );
        console.log('Polygon Coordinates (lon/lat):', transformedCoords);
        setDrawnPolygon(transformedCoords);
    });
    geofenceMapInstance.current.on('singleclick', (e) => {
        const coord = geofenceMapInstance.current.getCoordinateFromPixel(e.pixel);
        const [longitude, latitude] = ol.proj.toLonLat(coord);
        setGeofenceSettings(prev => ({
            ...prev,
            latitude,
            longitude
        }));
        previewGeofenceFeature.current.setGeometry(
            new ol.geom.Circle(coord, geofenceSettings.radius)
        );
    });

    // تحديث موقع الجهاز بناءً على آخر موقع معروف أو من locations
    const currentState = deviceStates[selectedDevice?.uuid] || {};
    let location = currentState.liveLocation || currentState.lastKnownLocation;
    
    if (!location && locations.length > 0) {
        location = locations[0];
    }

    if (location && location.latitude && location.longitude) {
        const coords = ol.proj.fromLonLat([location.longitude, location.latitude]);
        deviceLocationFeature.current.setGeometry(new ol.geom.Point(coords));
        deviceLocationFeature.current.setStyle(new ol.style.Style({
            image: new ol.style.Circle({
                radius: 6,
                fill: new ol.style.Fill({ color: 'red' }),
                stroke: new ol.style.Stroke({ color: 'white', width: 1 })
            }),
            text: new ol.style.Text({
                text: `${selectedDevice?.name || selectedDevice?.uuid}\n${formatLocalTime(location.captured_at)}`,
                font: '10px sans-serif',
                fill: new ol.style.Fill({ color: 'white' }),
                backgroundFill: new ol.style.Fill({ color: 'rgba(0, 0, 0, 0.7)' }),
                padding: [2, 6, 2, 6],
                offsetY: -40,
                textAlign: 'center',
                overflow: true
            })
        }));
        if (geofences.length === 0) {
            geofenceMapInstance.current.getView().animate({
                center: coords,
                zoom: 14,
                duration: 1000
            });
            setGeofenceMapCenter([location.longitude, location.latitude]);
            setGeofenceMapZoom(14);
        }
    }

    updateGeofenceMap();
    geofenceMapInstance.current.render();
    geofenceMapInitialized.current = true;
};

useEffect(() => {
    if (geofenceMapInstance.current && geofenceMapInitialized.current) {
        const layers = geofenceMapInstance.current.getLayers().getArray();
        let tileLayer = layers.find(layer => layer instanceof ol.layer.Tile);
        if (tileLayer) {
            geofenceMapInstance.current.removeLayer(tileLayer);
        }
        const newTileLayer = new ol.layer.Tile({
            source: getMapSource(mapType)
        });
        geofenceMapInstance.current.addLayer(newTileLayer);
        geofenceMapInstance.current.render();
    }
}, [mapType]);

            const updateGeofenceMap = () => {
    if (!geofenceVectorSource.current || !geofenceMapInstance.current) return;
    geofenceVectorSource.current.clear();
    geofenceFeatures.current = {};
    geofences.forEach(gf => {
        let geometry;
        if (gf.polygon_geometry) {
            geometry = new ol.geom.Polygon(
                gf.polygon_geometry.coordinates.map(ring =>
                    ring.map(coord => ol.proj.fromLonLat(coord))
                )
            );
        } else {
            geometry = new ol.geom.Circle(
                ol.proj.fromLonLat([gf.longitude, gf.latitude]),
                gf.radius
            );
        }
        const style = new ol.style.Style({
            stroke: new ol.style.Stroke({
                color: 'rgba(255, 255, 0, 0.7)',
                width: 2
            }),
            fill: new ol.style.Fill({
                color: `rgba(${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, 0.2)`
            }),
            text: new ol.style.Text({
                text: gf.name,
                font: '13px sans-serif',
                fill: new ol.style.Fill({ color: 'white' }),
                backgroundFill: new ol.style.Fill({ color: 'rgba(0, 0, 0, 0.6)' }),
                padding: [2, 4, 2, 4],
                textAlign: 'center',
                offsetY: -10,
                overflow: true,
                scale: 1.2
            })
        });
        const feature = new ol.Feature({
            geometry,
            name: gf.name
        });
        feature.setStyle(style);
        geofenceVectorSource.current.addFeature(feature);
        geofenceFeatures.current[gf.id] = feature;
    });
    if (geofenceVectorSource.current.getFeatures().length > 0) {
        const extent = geofenceVectorSource.current.getExtent();
        if (!ol.extent.isEmpty(extent)) {
            geofenceMapInstance.current.getView().fit(extent, {
                padding: [50, 50, 50, 50],
                duration: 1000,
                maxZoom: 16,
                minZoom: 10
            });
            const view = geofenceMapInstance.current.getView();
            setGeofenceMapCenter(ol.proj.toLonLat(view.getCenter()));
            setGeofenceMapZoom(view.getZoom());
        }
    } else {
        const currentState = deviceStates[selectedDevice?.uuid] || {};
        const location = currentState.liveLocation || currentState.lastKnownLocation;
        if (location && location.latitude && location.longitude) {
            const coords = ol.proj.fromLonLat([location.longitude, location.latitude]);
            geofenceMapInstance.current.getView().animate({
                center: coords,
                zoom: 14,
                duration: 1000
            });
            setGeofenceMapCenter([location.longitude, location.latitude]);
            setGeofenceMapZoom(14);
        }
    }
    geofenceMapInstance.current.render();
};

const fetchGeofenceEvents = async () => {
    const { data, error } = await supabase
        .from('geofence_events')
        .select('*')
        .order('timestamp', { ascending: false });
    if (error) {
        console.error("خطأ في تحميل أحداث Geofence:", error);
    } else {
        setGeofenceEvents(data);
    }
};


const updateDeviceLocationOnGeofenceMap = () => {
    if (!deviceLocationFeature.current || !geofenceMapInstance.current) return;
    const currentState = deviceStates[selectedDevice?.uuid] || {};
    let location = currentState.liveLocation || currentState.lastKnownLocation;

    // إذا لم يكن هناك liveLocation أو lastKnownLocation، استخدم أحدث موقع من locations
    if (!location && locations.length > 0) {
        location = locations[0]; // أحدث موقع من جدول locations
    }

    if (location && location.latitude && location.longitude) {
        const coords = ol.proj.fromLonLat([location.longitude, location.latitude]);
        deviceLocationFeature.current.setGeometry(new ol.geom.Point(coords));
        deviceLocationFeature.current.setStyle(new ol.style.Style({
            image: new ol.style.Circle({
                radius: 6,
                fill: new ol.style.Fill({ color: 'red' }),
                stroke: new ol.style.Stroke({ color: 'white', width: 1 })
            }),
            text: new ol.style.Text({
                text: `${selectedDevice?.name || selectedDevice?.uuid}\n${formatLocalTime(location.captured_at)}`,
                font: '10px sans-serif',
                fill: new ol.style.Fill({ color: 'white' }),
                backgroundFill: new ol.style.Fill({ color: 'rgba(0, 0, 0, 0.7)' }),
                padding: [2, 6, 2, 6],
                offsetY: -40,
                textAlign: 'center',
                overflow: true
            })
        }));
        if (geofences.length === 0) {
            geofenceMapInstance.current.getView().animate({
                center: coords,
                zoom: 14,
                duration: 1000
            });
            setGeofenceMapCenter([location.longitude, location.latitude]);
            setGeofenceMapZoom(14);
        }
        geofenceMapInstance.current.render();
    }
};;

const clearDrawnPolygon = () => {
    if (geofenceVectorSource.current) {
        geofenceVectorSource.current.clear();
    }
    setDrawnPolygon(null);
};

const savePolygonGeofence = async () => {
    if (!drawnPolygon) {
        alert("لا يوجد Polygon مرسوم.");
        return;
    }

    if (!selectedDevice || !selectedDevice?.uuid) {
        alert("يرجى اختيار الجهاز قبل حفظ Polygon Geofence.");
        return;
    }

    console.log("Selected Device:", selectedDevice);
    console.log("Polygon Coordinates:", drawnPolygon);

    const firstPoint = drawnPolygon?.[0]?.[0];
    if (!firstPoint) {
        alert("الـ Polygon فارغ أو غير صالح.");
        return;
    }

    const longitude = firstPoint[0];
    const latitude = firstPoint[1];

    console.log("Latitude:", latitude, "Longitude:", longitude);

    const geoJson = {
        type: 'Polygon',
        coordinates: drawnPolygon
    };

    const { data, error } = await supabase
        .from('geofences')
        .insert({
            name: geofenceSettings.name || "Polygon Geofence",
            device_id: selectedDevice.uuid,
            latitude,
            longitude,
            radius: geofenceSettings.radius || 500,
            polygon_geometry: geoJson
        })
        .select();

    if (error) {
        console.error("خطأ في حفظ Geofence:", JSON.stringify(error, null, 2));
    } else {
        console.log("تم حفظ Polygon Geofence:", data);
        clearDrawnPolygon();
        fetchGeofences();
    }
};


            const checkGeofenceWithServices = (lat, lng, capturedAt) => {
    if (!selectedDevice) return;

    const point = new ol.geom.Point(ol.proj.fromLonLat([lng, lat]));
    let foundGeofence = null;

    for (const gf of geofences) {
        let isInside = false;

        if (gf.polygon_geometry) {
            const polygon = new ol.geom.Polygon(
                gf.polygon_geometry.coordinates.map(ring =>
                    ring.map(coord => ol.proj.fromLonLat(coord))
                )
            );
            isInside = polygon.intersectsCoordinate(point.getCoordinates());
        } else {
            const distanceMeters = ol.sphere.getDistance(
                [gf.longitude, gf.latitude],
                [lng, lat]
            );
            isInside = distanceMeters <= gf.radius;
        }

        if (isInside) {
            foundGeofence = gf;
            break;
        }
    }

    const prevStatus = geofenceStatus[selectedDevice.uuid] || null;

    if ((foundGeofence?.id || null) !== prevStatus) {
        let message = "";

        if (foundGeofence && !prevStatus) {
            message = `دخول إلى المنطقة: ${foundGeofence.name || "غير معروفة"}`;
        } else if (!foundGeofence && prevStatus) {
            const gf = geofences.find(g => g.id === prevStatus);
            message = `خروج من المنطقة: ${gf?.name || "غير معروفة"}`;
        } else if (foundGeofence && prevStatus && foundGeofence.id !== prevStatus) {
            const fromGf = geofences.find(g => g.id === prevStatus);
            message = `انتقال من ${fromGf?.name || "غير معروفة"} إلى ${foundGeofence.name || "غير معروفة"}`;
        }

        if (message) {
            setGeofenceNotification(message);
            // تشغيل صوت التنبيه
            const audio = new Audio('https://www.soundjay.com/buttons/beep-01a.mp3');
            audio.play().catch(error => console.error('خطأ في تشغيل الصوت:', error));
            // إضافة تأثير وميض مرئي
            setTimeout(() => {
                const notificationElement = document.querySelector('.geofence-notification');
                if (notificationElement) {
                    notificationElement.style.animation = 'flash 0.5s ease-in-out 3';
                    setTimeout(() => {
                        notificationElement.style.animation = '';
                    }, 1500); // إزالة التأثير بعد 1.5 ثانية
                } else {
                    console.warn('لم يتم العثور على عنصر .geofence-notification');
                }
            }, 100); // تأخير طفيف لضمان عرض العنصر
            setTimeout(() => setGeofenceNotification(null), 5000);

            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    action: "geofence_trigger",
                    deviceId: selectedDevice.uuid,
                    message: message,
                    location: { lat, lng }
                }));
            }

            supabase.from('geofence_events').insert({
                device_id: selectedDevice.uuid,
                message: message,
                latitude: lat,
                longitude: lng,
                timestamp: capturedAt || new Date().toISOString(),
                geofence_id: foundGeofence?.id || null,
                event_type: foundGeofence ? "enter" : "exit"
            }).then(({ error }) => {
                if (error) console.error('خطأ في حفظ حدث Geofence:', error);
                else console.log("تم حفظ حدث Geofence بنجاح");
            });
        }

        setGeofenceStatus(prev => ({
            ...prev,
            [selectedDevice.uuid]: foundGeofence?.id || null
        }));
    }

    // تحديث موقع الجهاز في الخريطة الصغيرة
    if (deviceLocationFeature.current) {
        const coords = ol.proj.fromLonLat([lng, lat]);
        deviceLocationFeature.current.setGeometry(new ol.geom.Point(coords));
        if (!geofenceVectorSource.current.getFeatures().includes(deviceLocationFeature.current)) {
            geofenceVectorSource.current.addFeature(deviceLocationFeature.current);
        }
        const view = geofenceMapInstance.current?.getView();
        if (view) {
            view.animate({
                center: coords,
                duration: 500,
                zoom: Math.max(view.getZoom(), 14)
            });
        }

        
    // تحديث الحالة
    setGeofenceStatus(prev => ({
        ...prev,
        [selectedDevice.uuid]: currentInside
    }));
}
            };
            const getMapSource = (type) => {
                switch (type) {
                    case "terrain": return new ol.source.XYZ({
                        url: 'https://server.arcgisonline.com/ArcGIS/rest/services/Elevation/World_Hillshade/MapServer/tile/{z}/{y}/{x}',
                        attributions: 'Tiles © Esri'
                    });
                    case "security": return new ol.source.XYZ({
                        url: 'https://tiles.stadiamaps.com/tiles/alidade_smooth/{z}/{x}/{y}.png',
                        attributions: '© Stadia Maps'
                    });
                    case "thermal": return new ol.source.XYZ({
                        url: 'https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',
                        attributions: '© Google'
                    });
                    case "satellite": return new ol.source.XYZ({
                        url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                        attributions: 'Tiles © Esri'
                    });
                    default: return new ol.source.OSM();
                }
            };
            const updateMarkerStyle = () => {
                if (!markerFeature.current) return;
                const currentState = deviceStates[selectedDevice?.uuid] || {};
                const isMoving = currentState.liveLocation && currentState.isTracking;
                const baseRadius = 10;
                const pulseStyle = new ol.style.Style({
                    image: new ol.style.Circle({
                        radius: baseRadius + 5,
                        fill: new ol.style.Fill({ color: isMoving ? 'rgba(255, 0, 0, 0.3)' : 'rgba(0, 255, 0, 0.3)' }),
                        stroke: new ol.style.Stroke({ color: isMoving ? 'rgba(255, 0, 0, 0.5)' : 'rgba(0, 255, 0, 0.5)', width: 2 })
                    }),
                    zIndex: 0
                });
                const markerStyle = new ol.style.Style({
                    image: new ol.style.Circle({
                        radius: baseRadius,
                        fill: new ol.style.Fill({ color: isMoving ? 'rgba(255, 0, 0, 0.8)' : 'rgba(0, 255, 0, 0.8)' }),
                        stroke: new ol.style.Stroke({ color: 'white', width: 2 })
                    }),
                    zIndex: 1
                });
                const labelText = `${selectedDevice?.name || selectedDevice?.uuid}\n${formatLocalTime(currentState.liveLocation?.captured_at || currentState.lastKnownLocation?.captured_at || new Date().toISOString())}`;
                const label = new ol.style.Style({
                    text: new ol.style.Text({
                        text: labelText,
                        font: '10px sans-serif',
                        fill: new ol.style.Fill({ color: 'white' }),
                        backgroundFill: new ol.style.Fill({ color: 'rgba(0, 0, 0, 0.7)' }),
                        padding: [2, 6, 2, 6],
                        offsetY: -40,
                        textAlign: 'center',
                        overflow: true
                    }),
                    zIndex: 2
                });
                markerFeature.current.setStyle([pulseStyle, markerStyle, label]);
            };
            const updateSafetyCircleStyle = () => {
                if (!safetyCircleFeature.current) return;
                const currentState = deviceStates[selectedDevice?.uuid] || {};
                const isMoving = currentState.liveLocation && currentState.isTracking;
                const accuracy = currentState.liveLocation?.accuracy || currentState.lastKnownLocation?.accuracy || 1000;
                safetyCircleFeature.current.setGeometry(new ol.geom.Circle(
                    markerFeature.current.getGeometry().getCoordinates(),
                    accuracy
                ));
                safetyCircleFeature.current.setStyle(new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: isMoving ? 'rgba(255, 0, 0, 0.7)' : 'rgba(0, 255, 0, 0.7)',
                        width: 2
                    }),
                    fill: new ol.style.Fill({
                        color: isMoving ? 'rgba(255, 0, 0, 0.1)' : 'rgba(0, 255, 0, 0.1)'
                    })
                }));
            };
            const updatePulseAnimation = () => {
                if (!markerFeature.current || !mapInstance.current) return;
                let pulseRadius = 10;
                if (pulseIntervalRef.current) clearInterval(pulseIntervalRef.current);
                pulseIntervalRef.current = setInterval(() => {
                    const currentState = deviceStates[selectedDevice?.uuid] || {};
                    const isMoving = currentState.liveLocation && currentState.isTracking;
                    const pulseStyle = new ol.style.Style({
                        image: new ol.style.Circle({
                            radius: pulseRadius,
                            fill: new ol.style.Fill({ color: isMoving ? 'rgba(255, 0, 0, 0.3)' : 'rgba(0, 255, 0, 0.3)' }),
                            stroke: new ol.style.Stroke({ color: isMoving ? 'rgba(255, 0, 0, 0.5)' : 'rgba(0, 255, 0, 0.5)', width: 2 })
                        }),
                        zIndex: 0
                    });
                    const markerStyle = new ol.style.Style({
                        image: new ol.style.Circle({
                            radius: 10,
                            fill: new ol.style.Fill({ color: isMoving ? 'rgba(255, 0, 0, 0.8)' : 'rgba(0, 255, 0, 0.8)' }),
                            stroke: new ol.style.Stroke({ color: 'white', width: 2 })
                        }),
                        zIndex: 1
                    });
                    const labelText = `${selectedDevice?.name || selectedDevice?.uuid}\n${formatLocalTime(currentState.liveLocation?.captured_at || currentState.lastKnownLocation?.captured_at || new Date().toISOString())}`;
                    const label = new ol.style.Style({
                        text: new ol.style.Text({
                            text: labelText,
                            font: '10px sans-serif',
                            fill: new ol.style.Fill({ color: 'white' }),
                            backgroundFill: new ol.style.Fill({ color: 'rgba(0, 0, 0, 0.7)' }),
                            padding: [2, 6, 2, 6],
                            offsetY: -40,
                            textAlign: 'center',
                            overflow: true
                        }),
                        zIndex: 2
                    });
                    markerFeature.current.setStyle([pulseStyle, markerStyle, label]);
                    pulseRadius = (pulseRadius === 10) ? 15 : 10;
                }, 750);
            };
            const updateMap = (lat, lng, capturedAt) => {
                if (mapInstance.current && markerFeature.current && lat && lng && !isNaN(lat) && !isNaN(lng) && isMapLoaded) {
                    const newCoord = ol.proj.fromLonLat([lng, lat]);
                    markerFeature.current.setGeometry(new ol.geom.Point(newCoord));
                    if (safetyCircleFeature.current) {
                        updateSafetyCircleStyle();
                        if (!vectorLayer.current.getSource().getFeatures().includes(safetyCircleFeature.current)) {
                            vectorLayer.current.getSource().addFeature(safetyCircleFeature.current);
                        }
                    }
                    updateMarkerStyle();
                    updateTrail(lat, lng);
                    checkGeofenceWithServices(lat, lng, capturedAt);
                    if (autoZoomEnabled) {
                        const view = mapInstance.current.getView();
                        view.fit(vectorLayer.current.getSource().getExtent(), { padding: [50, 50, 50, 50], duration: 500 });
                    }
                    setCoords({ lat, lng });
                    mapInstance.current.render();
                } else {
                    console.error("إحداثيات غير صالحة أو الخريطة غير جاهزة لتحديث updateMap:", lat, lng, isMapLoaded);
                }
            };
            const updateTrail = (lat, lng) => {
                if (!trailLayer.current || !locations.length) return;
                const trailSource = trailLayer.current.getSource();
                const newFeature = new ol.Feature({
                    geometry: new ol.geom.Point(ol.proj.fromLonLat([lng, lat]))
                });
                newFeature.setStyle(new ol.style.Style({
                    image: new ol.style.Circle({
                        radius: 4,
                        fill: new ol.style.Fill({ color: 'rgba(255, 255, 0, 0.7)' })
                    })
                }));
                trailSource.addFeature(newFeature);
            };
            const addGeofence = async () => {
                if (!geofenceSettings.name || !selectedDevice?.uuid || !geofenceSettings.latitude || !geofenceSettings.longitude) {
                    alert('يرجى إدخال اسم المنطقة وتحديد الموقع بالنقر على الخريطة!');
                    return;
                }
                const { data, error } = await supabase
                    .from('geofences')
                    .insert({
                        device_id: selectedDevice.uuid,
                        name: geofenceSettings.name,
                        latitude: geofenceSettings.latitude,
                        longitude: geofenceSettings.longitude,
                        radius: geofenceSettings.radius
                    })
                    .select();
                if (error) console.error('خطأ في إضافة Geofence:', error);
                else {
                    setGeofenceSettings({ name: '', radius: 500, latitude: 0, longitude: 0 });
                    setGeofences(prev => [...prev, ...data]);
                }
            };
            const deleteGeofence = async (id) => {
                const { error } = await supabase.from('geofences').delete().eq('id', id);
                if (error) console.error('خطأ في الحذف:', error);
                else setGeofences(prev => prev.filter(gf => gf.id !== id));
            };
            const centerMapOnLocation = (lat, lng) => {
                if (mapInstance.current && lat && lng && !isNaN(lat) && !isNaN(lng)) {
                    const view = mapInstance.current.getView();
                    view.animate({
                        center: ol.proj.fromLonLat([lng, lat]),
                        zoom: 15,
                        duration: 500
                    });
                }
            };
            const startTimeUpdate = () => {
                if (timeIntervalRef.current) clearInterval(timeIntervalRef.current);
                timeIntervalRef.current = setInterval(() => {
                    if (deviceStates[selectedDevice?.uuid]?.isTracking && mapInstance.current && markerFeature.current) {
                        updateMarkerStyle();
                    }
                }, 1000);
            };
            const stopTimeUpdate = () => {
                if (timeIntervalRef.current) {
                    clearInterval(timeIntervalRef.current);
                    timeIntervalRef.current = null;
                }
            };
            const fetchLocations = async (deviceId) => {
                if (!deviceId) return;
                const { data, error } = await supabase
                    .from('locations')
                    .select('*')
                    .eq('device_id', deviceId)
                    .order('captured_at', { ascending: false });
                if (error) console.error('خطأ في جلب المواقع:', error);
                else setLocations(data.map(loc => ({
                    latitude: loc.latitude,
                    longitude: loc.longitude,
                    captured_at: loc.captured_at,
                    accuracy: loc.accuracy || 1000,
                    map_url: loc.map_url
                })));
            };
            const fetchAudioRecordings = async (deviceId) => {
                if (!deviceId) return;
                const { data, error } = await supabase
                    .from('audio_recordings')
                    .select('*')
                    .eq('device_id', deviceId)
                    .order('timestamp', { ascending: false });
                if (error) console.error('خطأ في جلب التسجيلات الصوتية:', error);
                else setAudioRecordings(data);
            };
            const fetchCalls = async (deviceId) => {
                if (!deviceId) return;
                const { data, error } = await supabase
                    .from('calls')
                    .select('*')
                    .eq('device_id', deviceId)
                    .order('timestamp', { ascending: false });
                if (error) console.error('خطأ في جلب المكالمات:', error);
                else setCalls(data);
            };
            const fetchMessages = async (deviceId) => {
                if (!deviceId) return;
                const { data, error } = await supabase
                    .from('messages')
                    .select('*')
                    .eq('device_id', deviceId)
                    .order('date', { ascending: false });
                if (error) {
                    console.error('خطأ في جلب الرسائل:', error);
                    alert('فشل في جلب الرسائل: ' + error.message);
                } else setMessages(data.map(msg => ({
                    address: msg.address,
                    content: msg.content,
                    date: msg.date,
                    type: msg.type,
                    name: msg.contactName || 'N/A'
                })));
            };
            const fetchWhatsAppMessages = async (deviceId) => {
                if (!deviceId) return;
                const { data, error } = await supabase
                    .from('whatsapp_messages')
                    .select('*')
                    .eq('device_id', deviceId)
                    .order('timestamp', { ascending: false });
                if (error) {
                    console.error('خطأ في جلب رسائل الواتساب:', error);
                    alert('فشل في جلب رسائل الواتساب: ' + error.message);
                } else setWhatsAppMessages(data.map(msg => ({
                    phoneNumber: msg.phone_number,
                    contactName: msg.contact_name || 'N/A',
                    content: msg.content || 'لا يوجد محتوى',
                    isSent: msg.is_sent,
                    timestamp: msg.timestamp
                })));
            };
            const fetchScreenshots = async (deviceId) => {
                if (!deviceId) return;
                try {
                    const { data, error } = await supabase
                        .from('manual-screenshots')
                        .select('*')
                        .eq('device_id', deviceId)
                        .order('captured_at', { ascending: false });
                    if (error) console.error('خطأ في جلب اللقطات اليدوية:', error.message, error.details);
                    else setScreenshots(data);
                } catch (e) {
                    console.error('خطأ غير متوقع في جلب اللقطات:', e);
                }
            };
            const fetchPeriodicScreenshots = async (deviceId) => {
                if (!deviceId) return;
                const { data, error } = await supabase
                    .from('screenshots')
                    .select('*')
                    .eq('device_id', deviceId)
                    .eq('is_periodic', true)
                    .order('captured_at', { ascending: false });
                if (error) console.error('خطأ في جلب اللقطات الدورية:', error);
                else setPeriodicScreenshots(data);
            };
            const fetchGeofences = async () => {
                if (!selectedDevice?.uuid) {
                    setGeofences([]);
                    return;
                }
                const { data, error } = await supabase
                    .from('geofences')
                    .select('*')
                    .eq('device_id', selectedDevice.uuid);
                if (error) console.error('خطأ في جلب Geofences:', error);
                else setGeofences(data);
            };
            const startPolling = () => {
                if (pollingIntervalRef.current) return;
                const pollingInterval = 30000;
                pollingIntervalRef.current = setInterval(() => {
                    if (ws && ws.readyState === WebSocket.OPEN) return;
                    if (selectedDevice) {
                        fetchMessages(selectedDevice.uuid);
                        fetchCalls(selectedDevice.uuid);
                        fetchScreenshots(selectedDevice.uuid);
                        fetchPeriodicScreenshots(selectedDevice.uuid);
                        fetchLocations(selectedDevice.uuid);
                        fetchAudioRecordings(selectedDevice.uuid);
                        fetchWhatsAppMessages(selectedDevice.uuid);
                        fetchGeofences();
                    }
                }, pollingInterval);
            };
            const stopPolling = () => {
                if (pollingIntervalRef.current) {
                    clearInterval(pollingIntervalRef.current);
                    pollingIntervalRef.current = null;
                }
            };
            const connectWebSocket = () => {
                if (reconnectAttempts.current >= maxReconnectAttempts) {
                    setConnectionStatus("فشل الاتصال نهائيًا، حاول لاحقًا");
                    startPolling();
                    return;
                }
                const socket = new WebSocket("wss://websocket-server-production-407b.up.railway.app");
                setWs(socket);
                console.log("جاري المحاولة للاتصال بالـ WebSocket...");
                socket.onopen = () => {
                    console.log("تم فتح الاتصال بـ WebSocket بنجاح");
                    setConnectionStatus("متصل بالخادم");
                    reconnectAttempts.current = 0;
                    stopPolling();
                    socket.send(JSON.stringify({ action: "dashboard_connect" }));
                };

                socket.onmessage = (event) => {
                    console.log("الجهاز المختار:", selectedDeviceRef.current?.uuid);
                    console.log("تم استلام رسالة WebSocket (غير مفككة):", event.data);
                    if (isValidJSON(event.data)) {
                        const data = JSON.parse(event.data);
                        console.log("البيانات المفككة:", data);
                        if (data.action === "device_list") {
                            const savedNames = JSON.parse(localStorage.getItem('deviceNames') || '{}');
                            const updatedDevices = data.devices.map(device => ({
                                ...device,
                                name: savedNames[device.uuid] || device.name || device.uuid
                            }));
                            setDevices(updatedDevices);
                        } else if (data.action === "message_update" && selectedDeviceRef.current && data.deviceId === selectedDeviceRef.current.uuid) {
                            setMessages(prev => [...prev, { address: data.address, content: data.content || data.body, date: new Date(data.date).toISOString(), type: data.type, name: data.contactName || 'N/A' }]);
                        } else if (data.action === "call_update" && selectedDeviceRef.current && data.deviceId === selectedDeviceRef.current.uuid) {
                            fetchCalls(data.deviceId);
                        } else if (data.action === "command_result" && selectedDeviceRef.current && data.deviceId === selectedDeviceRef.current.uuid) {
                            setCommandResults(prev => ({ ...prev, [data.command]: data.result }));
                            if (data.command === "take_screenshot") fetchScreenshots(data.deviceId);
                        } else if (data.action === "periodic_screenshot" && selectedDeviceRef.current && data.deviceId === selectedDeviceRef.current.uuid) {
                            fetchPeriodicScreenshots(data.deviceId);
                        } else if (data.action === "manual_screenshot" && selectedDeviceRef.current && data.deviceId === selectedDeviceRef.current.uuid) {
                            fetchScreenshots(data.deviceId);
                        } else if (data.action === "audio_recording" && selectedDeviceRef.current && data.deviceId === selectedDeviceRef.current.uuid) {
                            setCommandResults(prev => ({ ...prev, ['record_audio']: data.audioUrl }));
                            fetchAudioRecordings(data.deviceId);
                        } else if (data.action === "live_location" && selectedDeviceRef.current && data.deviceId === selectedDeviceRef.current.uuid) {
    console.log("تحديث الموقع المباشر:", data.latitude, data.longitude);
    if (data.latitude && data.longitude && !isNaN(parseFloat(data.latitude)) && !isNaN(parseFloat(data.longitude))) {
        const newLat = parseFloat(data.latitude);
        const newLng = parseFloat(data.longitude);
        if (newLat >= -90 && newLat <= 90 && newLng >= -180 && newLng <= 180) {
            setDeviceStates(prev => ({
                ...prev,
                [selectedDeviceRef.current.uuid]: {
                    ...prev[selectedDeviceRef.current.uuid],
                    liveLocation: {
                        latitude: newLat,
                        longitude: newLng,
                        captured_at: data.captured_at || new Date().toISOString(),
                        accuracy: data.accuracy || 1000
                    },
                    lastKnownLocation: {
                        latitude: newLat,
                        longitude: newLng,
                        captured_at: data.captured_at || new Date().toISOString(),
                        accuracy: data.accuracy || 1000
                    }
                }
            }));

            // ✅ هنا أضف الكود الجديد بدلاً من السطر القديم:
            checkGeofenceWithServices(newLat, newLng, data.captured_at || new Date().toISOString());

            if (deviceStates[selectedDeviceRef.current.uuid]?.isTracking && mapInstance.current && isMapLoaded) {
                updateMap(newLat, newLng, data.captured_at);
            }
            updateDeviceLocationOnGeofenceMap();

        } else {
            console.error("الإحداثيات خارج النطاق:", newLat, newLng);
        }
    } else {
        console.error("إحداثيات غير صالحة تم استقبالها:", data.latitude, data.longitude);
    }
                        } else if (data.action === "whatsapp_message_update" && selectedDeviceRef.current && data.deviceId === selectedDeviceRef.current.uuid) {
                            setWhatsAppMessages(prev => [...prev, { phoneNumber: data.phoneNumber, contactName: data.contactName || 'N/A', content: data.content, isSent: data.isSent, timestamp: data.timestamp }]);
                        } else if (data.action === "subscription_confirmed") {
                            console.log("تم تأكيد الاشتراك للجهاز:", data.deviceId);
                            const matchedDevice = devices.find(d => d.uuid === data.deviceId);
                            if (matchedDevice && !selectedDeviceRef.current) {
                                setSelectedDevice(matchedDevice);
                                selectedDeviceRef.current = matchedDevice;
                                console.log("تم اختيار الجهاز تلقائيًا:", matchedDevice.uuid);
                            }
                        } else if (data.action === "subscription_error") {
                            console.error("خطأ في الاشتراك:", data.message);
                        } else {
                            console.log("إجراء رسالة غير معالج:", data.action);
                        }
                    } else {
                        console.error("JSON غير صالح تم استقباله:", event.data);
                    }
                };
                socket.onclose = () => {
                    console.log("تم إغلاق اتصال WebSocket، جاري إعادة المحاولة...");
                    setConnectionStatus("تم قطع الاتصال، جاري إعادة الاتصال...");
                    setDeviceStates(prev => ({ ...prev, [selectedDevice?.uuid]: { ...prev[selectedDevice?.uuid], liveLocation: null } }));
                    reconnectAttempts.current += 1;
                    startPolling();
                    const delay = baseReconnectDelay * Math.pow(2, reconnectAttempts.current);
                    setTimeout(connectWebSocket, delay);
                };
                socket.onerror = (error) => {
                    console.error("خطأ في WebSocket:", error);
                    setConnectionStatus("فشل الاتصال بالخادم");
                    setDeviceStates(prev => ({ ...prev, [selectedDevice?.uuid]: { ...prev[selectedDevice?.uuid], liveLocation: null } }));
                    startPolling();
                };
            };
useEffect(() => {
    const channel = supabase
        .channel('geofence_events_changes')
        .on(
            'postgres_changes',
            {
                event: 'INSERT',
                schema: 'public',
                table: 'geofence_events',
            },
            (payload) => {
                console.log('🟡 حدث جديد من Supabase:', payload);

                // أضف الحدث إلى القائمة
                setGeofenceEvents((prev) => [payload.new, ...prev]);

                // أظهر Badge على الأيقونة
                setHasNewGeofenceNotification(true);

                // أظهر إشعار سريع في أعلى الشاشة
                setGeofenceNotification(payload.new.message);

                setTimeout(() => {
                    setGeofenceNotification(null);
                }, 5000);

                // حرّك الخريطة الصغيرة إلى الموقع
                if (payload.new.latitude && payload.new.longitude && deviceLocationFeature.current) {
                    const coords = ol.proj.fromLonLat([
                        payload.new.longitude,
                        payload.new.latitude
                    ]);
                    deviceLocationFeature.current.setGeometry(
                        new ol.geom.Point(coords)
                    );

                    const view = geofenceMapInstance.current?.getView();
                    if (view) {
                        view.animate({
                            center: coords,
                            duration: 500,
                            zoom: Math.max(view.getZoom(), 14)
                        });
                    }
                }
            }
        )
        .subscribe();

    return () => {
        supabase.removeChannel(channel);
    };
}, []);


            useEffect(() => {
                const savedNames = JSON.parse(localStorage.getItem('deviceNames') || '{}');
                const updatedDevices = devices.map(device => ({
                    ...device,
                    name: savedNames[device.uuid] || device.name || device.uuid
                }));
                setDevices(updatedDevices);
            }, []);
            useEffect(() => {
                connectWebSocket();
                startPolling();
                return () => {
                    if (ws) ws.close();
                    stopPolling();
                    stopTimeUpdate();
                    if (pulseIntervalRef.current) clearInterval(pulseIntervalRef.current);
                    if (mapInstance.current) mapInstance.current.setTarget(null);
                    if (geofenceMapInstance.current) geofenceMapInstance.current.setTarget(null);
                };
            }, []);
            useEffect(() => {
                if (selectedDevice && mapRef.current && !isMapLoaded) {
                    selectedDeviceRef.current = selectedDevice;
                    initializeMap();
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({ action: "subscribe_to_device", deviceId: selectedDevice.uuid }));
                        console.log("تم الاشتراك في الجهاز:", selectedDevice.uuid);
                    }
                    setDeviceStates(prev => ({
                        ...prev,
                        [selectedDevice.uuid]: {
                            ...prev[selectedDevice.uuid],
                            liveLocation: null,
                            lastKnownLocation: null,
                            isTracking: false
                        }
                    }));
                    fetchGeofences();
                } else if (!selectedDevice && mapRef.current && !isMapLoaded) {
                    initializeMap();
                }
            }, [selectedDevice, ws, isMapLoaded, mapType]);
            useEffect(() => {
                if (mapInstance.current && isMapLoaded) {
                    const layers = mapInstance.current.getLayers().getArray();
                    let tileLayer = layers.find(layer => layer instanceof ol.layer.Tile);
                    if (tileLayer) {
                        mapInstance.current.removeLayer(tileLayer);
                    }
                    const newTileLayer = new ol.layer.Tile({
                        source: getMapSource(mapType)
                    });
                    mapInstance.current.addLayer(newTileLayer);
                    if (vectorLayer.current) {
                        if (!layers.includes(vectorLayer.current)) {
                            mapInstance.current.addLayer(vectorLayer.current);
                        }
                        vectorLayer.current.setVisible(true);
                        const vectorSource = vectorLayer.current.getSource();
                        if (markerFeature.current) {
                            if (!vectorSource.getFeatures().includes(markerFeature.current)) {
                                vectorSource.addFeature(markerFeature.current);
                            }
                        }
                        if (safetyCircleFeature.current && !vectorSource.getFeatures().includes(safetyCircleFeature.current)) {
                            vectorSource.addFeature(safetyCircleFeature.current);
                        }
                    }
                    if (trailLayer.current && !layers.includes(trailLayer.current)) {
                        mapInstance.current.addLayer(trailLayer.current);
                    }
                }
            }, [mapType]);
            useEffect(() => {
                if (selectedTab === 'geofences' && geofenceMapRef.current && selectedDevice) {
                    initializeGeofenceMap();
                    fetchGeofences();
                }
                return () => {
                    if (geofenceMapInstance.current) {
                        geofenceMapInstance.current.setTarget(null);
                    }
                };
            }, [selectedTab, selectedDevice]);
            useEffect(() => {
                const currentState = deviceStates[selectedDevice?.uuid] || {};
                if (currentState.liveLocation && mapInstance.current && markerFeature.current && isMapLoaded && currentState.isTracking) {
                    updateMap(currentState.liveLocation.latitude, currentState.liveLocation.longitude, currentState.liveLocation.captured_at);
                } else if (mapInstance.current && markerFeature.current && selectedDevice && !currentState.isTracking && currentState.lastKnownLocation) {
                    updateMap(currentState.lastKnownLocation.latitude, currentState.lastKnownLocation.longitude, currentState.lastKnownLocation.captured_at);
                }
            }, [deviceStates, selectedDevice, isMapLoaded]);
            useEffect(() => {
                const currentState = deviceStates[selectedDevice?.uuid] || {};
                if (currentState.isTracking) {
                    startTimeUpdate();
                    updatePulseAnimation();
                } else {
                    stopTimeUpdate();
                    if (pulseIntervalRef.current) clearInterval(pulseIntervalRef.current);
                    if (markerFeature.current && currentState.lastKnownLocation) {
                        updateMarkerStyle();
                    }
                }
            }, [deviceStates, selectedDevice]);
            useEffect(() => {
                if (geofenceMapInitialized.current) {
                    updateGeofenceMap();
                }
            }, [geofences]);
            useEffect(() => {
                if (geofenceMapInitialized.current) {
                    updateDeviceLocationOnGeofenceMap();
                }
            }, [deviceStates, selectedDevice]);
            useEffect(() => {
                if (locations.length > 0 && selectedDevice) {
                    const latestLocation = locations[0];
                    checkGeofenceWithServices(latestLocation.latitude, latestLocation.longitude, latestLocation.captured_at);
                }
            }, [locations]);
            useEffect(() => {
                if (geofenceNotification) {
                    const timer = setTimeout(() => {
                        setGeofenceNotification(null);
                    }, 5000);
                    return () => clearTimeout(timer);
                }
            }, [geofenceNotification]);
            const selectDevice = (device) => {
                console.log("اختيار الجهاز:", device.uuid);
                setSelectedDevice(device);
                setMessages([]);
                setCalls([]);
                setCommandResults({});
                setScreenshots([]);
                setPeriodicScreenshots([]);
                setLocations([]);
                setAudioRecordings([]);
                setWhatsAppMessages([]);
                setGeofences([]);
                setGeofenceStatus(prev => ({ ...prev, [device.uuid]: null }));
                if (mapRef.current && !isMapLoaded) {
                    initializeMap();
                }
                setDeviceStates(prev => ({
                    ...prev,
                    [device.uuid]: {
                        ...prev[device.uuid],
                        liveLocation: null,
                        lastKnownLocation: null,
                        isTracking: false
                    }
                }));
                fetchLocations(device.uuid);
                fetchAudioRecordings(device.uuid);
                fetchCalls(device.uuid);
                fetchMessages(device.uuid);
                fetchScreenshots(device.uuid);
                fetchPeriodicScreenshots(device.uuid);
                fetchWhatsAppMessages(device.uuid);
                fetchGeofences();
                console.log("تم اختيار الجهاز وتهيئة الخريطة:", device.uuid);
            };
            const sendCommand = (command) => {
                if (ws && ws.readyState === WebSocket.OPEN && selectedDevice) {
                    const message = JSON.stringify({ action: command, deviceId: selectedDevice.uuid, duration: command === "record_audio" ? 15000 : undefined });
                    ws.send(message);
                    console.log("تم إرسال الأمر:", message);
                } else console.error("WebSocket غير متصل أو لم يتم اختيار جهاز");
            };
            const startLiveTracking = () => {
                if (ws && ws.readyState === WebSocket.OPEN && selectedDevice && !deviceStates[selectedDevice.uuid]?.isTracking) {
                    ws.send(JSON.stringify({ action: "start_live_tracking", deviceId: selectedDevice.uuid, duration: 300000 }));
                    setDeviceStates(prev => ({
                        ...prev,
                        [selectedDevice.uuid]: { ...prev[selectedDevice.uuid], isTracking: true }
                    }));
                    console.log("بدء التتبع المباشر للجهاز:", selectedDevice.uuid);
                }
            };
            const stopLiveTracking = () => {
                if (ws && ws.readyState === WebSocket.OPEN && selectedDevice && deviceStates[selectedDevice.uuid]?.isTracking) {
                    ws.send(JSON.stringify({ action: "stop_live_tracking", deviceId: selectedDevice.uuid }));
                    const currentState = deviceStates[selectedDevice.uuid] || {};
                    const lastLat = currentState.liveLocation?.latitude || currentState.lastKnownLocation?.latitude || 0;
                    const lastLng = currentState.liveLocation?.longitude || currentState.lastKnownLocation?.longitude || 0;
                    setDeviceStates(prev => ({
                        ...prev,
                        [selectedDevice.uuid]: {
                            ...prev[selectedDevice.uuid],
                            isTracking: false,
                            lastKnownLocation: { latitude: lastLat, longitude: lastLng, captured_at: currentState.liveLocation?.captured_at || new Date().toISOString(), accuracy: currentState.liveLocation?.accuracy || 1000 }
                        }
                    }));
                    if (mapInstance.current && markerFeature.current) {
                        updateMap(lastLat, lastLng);
                        centerMapOnLocation(lastLat, lastLng);
                    }
                    console.log("إيقاف التتبع المباشر للجهاز:", selectedDevice.uuid, "في", lastLat, lastLng);
                }
            };
            const saveDeviceName = (deviceUuid) => {
                const savedNames = JSON.parse(localStorage.getItem('deviceNames') || '{}');
                savedNames[deviceUuid] = newDeviceName;
                localStorage.setItem('deviceNames', JSON.stringify(savedNames));
                const updatedDevices = devices.map(device =>
                    device.uuid === deviceUuid ? { ...device, name: newDeviceName } : device
                );
                setDevices(updatedDevices);
                setIsEditing(null);
                setNewDeviceName("");
                console.log("تم تحديث وتخزين اسم الجهاز:", deviceUuid, newDeviceName);
            };
            const deleteDevice = (deviceUuid) => {
                if (window.confirm(`هل أنت متأكد من حذف الجهاز ${devices.find(d => d.uuid === deviceUuid)?.name || deviceUuid}?`)) {
                    const updatedDevices = devices.filter(device => device.uuid !== deviceUuid);
                    setDevices(updatedDevices);
                    const savedNames = JSON.parse(localStorage.getItem('deviceNames') || '{}');
                    delete savedNames[deviceUuid];
                    localStorage.setItem('deviceNames', JSON.stringify(savedNames));
                    console.log("تم حذف الجهاز:", deviceUuid);
                }
            };
            return (
                    <div className="min-h-screen p-6 text-gray-100">
                    {geofenceNotification && (
                        <div className="geofence-notification">
                            {geofenceNotification}
                        </div>
                    )}
                    <div className="mb-4 text-lg font-semibold">
                        حالة الاتصال: <span className={connectionStatus.includes("متصل") ? "text-green-400" : "text-red-400"}>{connectionStatus}</span>
                    </div>
                    {!selectedDevice ? (
                        <div>
                            <h1 className="text-3xl font-bold text-blue-400 mb-6 hud-effect">الأجهزة المراقبة</h1>
                            {devices.length === 0 ? (
                                <p className="text-gray-400">لا يوجد أجهزة متاحة في الوقت الحالي...</p>
                            ) : (
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    {devices.map((device) => (
                                        <div key={device.uuid} className="relative">
                                            {isEditing === device.uuid ? (
                                                <div className="bg-gray-800 shadow-md rounded-lg p-4 hud-effect">
                                                    <input
                                                        type="text"
                                                        value={newDeviceName}
                                                        onChange={(e) => setNewDeviceName(e.target.value)}
                                                        className="w-full p-2 border border-gray-600 rounded-lg mb-2 bg-gray-700 text-white"
                                                        placeholder="أدخل الاسم الجديد"
                                                    />
                                                    <button
                                                        onClick={() => saveDeviceName(device.uuid)}
                                                        className="bg-blue-500 text-white px-3 py-1 rounded-lg hover:bg-blue-600 transition duration-200 mr-2"
                                                    >
                                                        حفظ
                                                    </button>
                                                    <button
                                                        onClick={() => setIsEditing(null)}
                                                        className="bg-gray-500 text-white px-3 py-1 rounded-lg hover:bg-gray-600 transition duration-200"
                                                    >
                                                        إلغاء
                                                    </button>
                                                </div>
                                            ) : (
                                                <div
                                                    onClick={() => selectDevice(device)}
                                                    className="bg-gray-800 shadow-md rounded-lg p-4 cursor-pointer hover:bg-gray-700 transition duration-200 hud-effect"
                                                    style={{ touchAction: "manipulation" }}
                                                >
                                                    <h2 className="text-xl font-semibold text-blue-400">جهاز {device.name || device.uuid}</h2>
                                                    <p className="text-gray-400">UUID: {device.uuid}</p>
                                                    <p className="text-lg">
                                                        الحالة: <span className={device.connected ? "text-green-400" : "text-red-400"}>
                                                            {device.connected ? "متصل" : "غير متصل"}
                                                        </span>
                                                    </p>
                                                    <p className="text-gray-400">آخر اتصال: {formatLocalTime(device.lastConnected)}</p>
                                                    <div className="mt-2 flex space-x-2">
                                                        <button
                                                            onClick={(e) => {
                                                                e.stopPropagation();
                                                                setIsEditing(device.uuid);
                                                                setNewDeviceName(device.name || device.uuid);
                                                            }}
                                                            className="bg-yellow-500 text-white px-2 py-1 rounded-lg hover:bg-yellow-600 transition duration-200"
                                                        >
                                                            تعديل الاسم
                                                        </button>
                                                        <button
                                                            onClick={(e) => {
                                                                e.stopPropagation();
                                                                deleteDevice(device.uuid);
                                                            }}
                                                            className="bg-red-500 text-white px-2 py-1 rounded-lg hover:bg-red-600 transition duration-200"
                                                        >
                                                            حذف
                                                        </button>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    ) : (
                        <div>
                            <button
                                onClick={() => setSelectedDevice(null)}
                                className="mb-4 bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition duration-200 hud-effect"
                            >
                                العودة إلى قائمة الأجهزة
                            </button>
                           <button
    className="relative ml-4 bg-gray-800 hover:bg-gray-700 text-white px-4 py-2 rounded flex items-center"
    onClick={() => {
        fetchGeofenceEvents();
        setShowEventsModal(true);
        setHasNewGeofenceNotification(false);
    }}
>
    <svg
        className="w-6 h-6 mr-2 text-yellow-400"
        fill="none"
        stroke="currentColor"
        strokeWidth="2"
        viewBox="0 0 24 24"
    >
        <path
            strokeLinecap="round"
            strokeLinejoin="round"
            d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14V9a6 6 0 10-12 0v5c0 .386-.148.735-.405 1.005L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"
        />
    </svg>
    إشعارات Geofence
    {hasNewGeofenceNotification && (
        <span className="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 bg-red-600 rounded-full">
            جديد
        </span>
    )}
</button>

{showEventsModal && (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
        <div className="bg-gray-900 text-white p-6 rounded-lg shadow-xl w-[500px] max-h-[80vh] overflow-y-auto relative">
            <button
                className="absolute top-2 right-2 text-gray-400 hover:text-white text-xl"
                onClick={() => setShowEventsModal(false)}
            >
                &times;
            </button>
            <h2 className="text-2xl font-bold mb-4 border-b border-gray-700 pb-2">
                سجل إشعارات Geofence
            </h2>
            {geofenceEvents.length === 0 ? (
                <p className="text-gray-400">لا توجد إشعارات محفوظة.</p>
            ) : (
                <ul className="space-y-3">
                    {geofenceEvents.map((event) => (
                        <li
                            key={event.id}
                            className="p-3 bg-gray-800 rounded hover:bg-gray-700 transition"
                        >
                            <div className="text-lg font-semibold text-yellow-400">
                                {event.message}
                            </div>
                            <div className="text-sm text-gray-400">
                                {new Date(event.timestamp).toLocaleString()}
                            </div>
                            <div className="text-xs text-gray-500 mt-1">
                                lat: {event.latitude}, lng: {event.longitude}
                            </div>
                        </li>
                    ))}
                </ul>
            )}
        </div>
    </div>
)}

                         <div className="mb-4">
                                <button
                                    onClick={() => setSelectedTab('tracking')}
                                    className={`px-4 py-2 rounded-lg ${selectedTab === 'tracking' ? 'bg-blue-500' : 'bg-gray-600'} text-white mr-2`}
                                >
                                    التتبع المباشر
                                </button>
                                <button
                                    onClick={() => setSelectedTab('geofences')}
                                    className={`px-4 py-2 rounded-lg ${selectedTab === 'geofences' ? 'bg-blue-500' : 'bg-gray-600'} text-white`}
                                >
                                    إدارة Geofence
                                </button>
                            </div>
                            {selectedTab === 'tracking' ? (
                                <div>
                                    <div className="bg-gray-800 shadow-md rounded-lg p-6 mb-6 hud-effect">
                                        <h2 className="text-xl font-semibold text-blue-400 mb-2">حالة الجهاز</h2>
                                        <p className="text-lg">
                                            الحالة: <span className={selectedDevice.connected ? "text-green-400" : "text-red-400"}>
                                                {selectedDevice.connected ? "متصل" : "غير متصل"}
                                            </span>
                                        </p>
                                        <p className="text-gray-400">آخر اتصال: {formatLocalTime(selectedDevice.lastConnected)}</p>
                                        <p className="text-gray-400">البطارية: {selectedDevice.batteryPercentage || "N/A"}%</p>
                                    </div>
                                    <div className="bg-gray-800 shadow-md rounded-lg p-6 mb-6 relative hud-effect">
                                        <h3 className="text-lg font-semibold text-blue-400 mb-4">تتبع الموقع المباشر</h3>
                                        <div className="flex space-x-4 mb-4">
                                            <button
                                                onClick={startLiveTracking}
                                                disabled={deviceStates[selectedDevice?.uuid]?.isTracking}
                                                className="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition duration-200 disabled:bg-gray-600 disabled:cursor-not-allowed"
                                            >
                                                بدء التتبع
                                            </button>
                                            <button
                                                onClick={stopLiveTracking}
                                                disabled={!deviceStates[selectedDevice?.uuid]?.isTracking}
                                                className="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition duration-200 disabled:bg-gray-600 disabled:cursor-not-allowed"
                                            >
                                                إيقاف التتبع
                                            </button>
                                            <button
                                                onClick={() => {
                                                    const currentState = deviceStates[selectedDevice?.uuid] || {};
                                                    centerMapOnLocation(currentState.lastKnownLocation?.latitude || 0, currentState.lastKnownLocation?.longitude || 0);
                                                }}
                                                disabled={!deviceStates[selectedDevice?.uuid]?.lastKnownLocation}
                                                className="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition duration-200 disabled:bg-gray-600 disabled:cursor-not-allowed"
                                            >
                                                تثبيت على الموقع
                                            </button>
                                            <select
                                                value={mapType}
                                                onChange={(e) => setMapType(e.target.value)}
                                                className="p-2 border border-gray-600 rounded-lg bg-gray-700 text-white"
                                            >
                                                <option value="standard">خريطة قياسية</option>
                                                <option value="satellite">قمر صناعي</option>
                                                <option value="terrain">تضاريس</option>
                                                <option value="security">أمان نيون</option>
                                                <option value="thermal">حراري</option>
                                            </select>
                                            <button
                                                onClick={() => setAutoZoomEnabled(!autoZoomEnabled)}
                                                className={`px-4 py-2 rounded-lg ${autoZoomEnabled ? 'bg-blue-500' : 'bg-gray-600'} text-white hover:${autoZoomEnabled ? 'bg-blue-600' : 'bg-gray-700'} transition duration-200`}
                                            >
                                                {autoZoomEnabled ? 'تعطيل التكبير التلقائي' : 'تفعيل التكبير التلقائي'}
                                            </button>
                                        </div>
                                        <div ref={mapRef} className="w-full h-96 rounded-lg overflow-hidden" style={{ position: 'relative', minHeight: '400px' }}></div>
                                        <div className="coords-box">
                                            <p>Lat: {coords.lat.toFixed(6)}, Lon: {coords.lng.toFixed(6)}</p>
                                            <p>UTM: {toUTM(coords.lat, coords.lng)}</p>
                                            <button
                                                onClick={() => navigator.clipboard.writeText(`Lat: ${coords.lat.toFixed(6)}, Lon: ${coords.lng.toFixed(6)}`)}
                                                className="bg-blue-500 text-white px-2 py-1 rounded-lg hover:bg-blue-600 transition duration-200 mt-1 w-full"
                                            >
                                                Copy
                                            </button>
                                        </div>
                                        <p className="mt-2 text-gray-400">
                                            آخر تحديث: {formatLocalTime(deviceStates[selectedDevice?.uuid]?.liveLocation?.captured_at || deviceStates[selectedDevice?.uuid]?.lastKnownLocation?.captured_at || new Date().toISOString())}
                                        </p>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                                        <div className="bg-gray-800 shadow-md rounded-lg p-4 hover:bg-gray-700 transition duration-200 hud-effect">
                                            <h3 className="text-lg font-semibold text-blue-400">الرسائل</h3>
                                            <button
                                                onClick={() => fetchMessages(selectedDevice.uuid)}
                                                className="mt-2 bg-blue-500 text-white px-3 py-1 rounded-lg hover:bg-blue-600 transition duration-200"
                                            >
                                                تحديث الرسائل
                                            </button>
                                            {messages.length > 0 ? (
                                                <div className="mt-4 overflow-x-auto">
                                                    <table className="min-w-full bg-gray-700 border border-gray-600 rounded-lg">
                                                        <thead>
                                                            <tr className="bg-gray-600 border-b">
                                                                <th className="py-2 px-4 text-right text-gray-300 font-semibold">النوع</th>
                                                                <th className="py-2 px-4 text-right text-gray-300 font-semibold">الاسم</th>
                                                                <th className="py-2 px-4 text-right text-gray-300 font-semibold">العنوان</th>
                                                                <th className="py-2 px-4 text-right text-gray-300 font-semibold">المحتوى</th>
                                                                <th className="py-2 px-4 text-right text-gray-300 font-semibold">التاريخ</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {messages.map((msg, index) => (
                                                                <tr key={index} className="border-b hover:bg-gray-600 transition duration-200">
                                                                    <td className="py-2 px-4 text-right">{msg.type === 'sent' ? 'مرسلة' : msg.type === 'received' ? 'مستلمة' : msg.type}</td>
                                                                    <td className="py-2 px-4 text-right">{msg.name}</td>
                                                                    <td className="py-2 px-4 text-right">{msg.address || 'N/A'}</td>
                                                                    <td className="py-2 px-4 text-right">{msg.content || 'لا يوجد محتوى'}</td>
                                                                    <td className="py-2 px-4 text-right">{formatLocalTime(msg.date)}</td>
                                                                </tr>
                                                            ))}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            ) : (
                                                <p className="mt-2 text-gray-400">لا توجد رسائل متاحة.</p>
                                            )}
                                        </div>
                                        <div className="bg-gray-800 shadow-md rounded-lg p-4 hover:bg-gray-700 transition duration-200 hud-effect">
                                            <h3 className="text-lg font-semibold text-blue-400">المكالمات</h3>
                                            <button
                                                onClick={() => fetchCalls(selectedDevice.uuid)}
                                                className="mt-2 bg-blue-500 text-white px-3 py-1 rounded-lg hover:bg-blue-600 transition duration-200"
                                            >
                                                تحديث المكالمات
                                            </button>
                                            {calls.length > 0 ? (
                                                <div className="mt-4 overflow-x-auto">
                                                    <table className="min-w-full bg-gray-700 border border-gray-600 rounded-lg">
                                                        <thead>
                                                            <tr className="bg-gray-600 border-b">
                                                                <th className="py-2 px-4 text-right text-gray-300 font-semibold">النوع</th>
                                                                <th className="py-2 px-4 text-right text-gray-300 font-semibold">الرقم</th>
                                                                <th className="py-2 px-4 text-right text-gray-300 font-semibold">الاسم</th>
                                                                <th className="py-2 px-4 text-right text-gray-300 font-semibold">التاريخ</th>
                                                                <th className="py-2 px-4 text-right text-gray-300 font-semibold">التسجيل</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {calls.map((call, index) => (
                                                                <tr key={index} className="border-b hover:bg-gray-600 transition duration-200">
                                                                    <td className="py-2 px-4 text-right">{call.call_type}</td>
                                                                    <td className="py-2 px-4 text-right">{call.phone_number || 'N/A'}</td>
                                                                    <td className="py-2 px-4 text-right">{call.contactName || 'N/A'}</td>
                                                                    <td className="py-2 px-4 text-right">{formatLocalTime(call.timestamp)}</td>
                                                                    <td className="py-2 px-4 text-right">
                                                                        {call.recording_url ? (
                                                                            <div>
                                                                                <audio controls className="mt-1 w-full">
                                                                                    <source src={call.recording_url} type="audio/mp4" />
                                                                                    متصفحك لا يدعم عنصر الصوت.
                                                                                </audio>
                                                                                <a href={call.recording_url} target="_blank" className="text-blue-400 ml-2">عرض</a>
                                                                                <a href={call.recording_url} download className="text-blue-400 ml-2">تنزيل</a>
                                                                            </div>
                                                                        ) : (
                                                                            <span className="text-gray-500 ml-2">لا يوجد تسجيل</span>
                                                                        )}
                                                                    </td>
                                                                </tr>
                                                            ))}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            ) : (
                                                <p className="mt-2 text-gray-400">لا توجد مكالمات متاحة.</p>
                                            )}
                                        </div>
                                        <div className="bg-gray-800 shadow-md rounded-lg p-4 hover:bg-gray-700 transition duration-200 hud-effect">
                                            <h3 className="text-lg font-semibold text-blue-400">رسائل الواتساب</h3>
                                            <button
                                                onClick={() => fetchWhatsAppMessages(selectedDevice.uuid)}
                                                className="mt-2 bg-blue-500 text-white px-3 py-1 rounded-lg hover:bg-blue-600 transition duration-200"
                                            >
                                                تحديث رسائل الواتساب
                                            </button>
                                            {whatsAppMessages.length > 0 ? (
                                                <div className="mt-4 overflow-x-auto">
                                                    <table className="min-w-full bg-gray-700 border border-gray-600 rounded-lg">
                                                        <thead>
                                                            <tr className="bg-gray-600 border-b">
                                                                <th className="py-2 px-4 text-right text-gray-300 font-semibold">الرقم</th>
                                                                <th className="py-2 px-4 text-right text-gray-300 font-semibold">الاسم</th>
                                                                <th className="py-2 px-4 text-right text-gray-300 font-semibold">المحتوى</th>
                                                                <th className="py-2 px-4 text-right text-gray-300 font-semibold">النوع</th>
                                                                <th className="py-2 px-4 text-right text-gray-300 font-semibold">التاريخ</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {whatsAppMessages.map((msg, index) => (
                                                                <tr key={index} className="border-b hover:bg-gray-600 transition duration-200">
                                                                    <td className="py-2 px-4 text-right">{msg.phoneNumber || 'N/A'}</td>
                                                                    <td className="py-2 px-4 text-right">{msg.contactName}</td>
                                                                    <td className="py-2 px-4 text-right">{msg.content}</td>
                                                                    <td className="py-2 px-4 text-right">{msg.isSent ? 'مرسلة' : 'مستلمة'}</td>
                                                                    <td className="py-2 px-4 text-right">{formatLocalTime(msg.timestamp)}</td>
                                                                </tr>
                                                            ))}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            ) : (
                                                <p className="mt-2 text-gray-400">لا توجد رسائل واتساب متاحة.</p>
                                            )}
                                        </div>
                                        <div className="bg-gray-800 shadow-md rounded-lg p-4 hover:bg-gray-700 transition duration-200 hud-effect">
                                            <h3 className="text-lg font-semibold text-blue-400">المواقع</h3>
                                            <button
                                                onClick={() => sendCommand("get_location")}
                                                className="mt-2 bg-blue-500 text-white px-3 py-1 rounded-lg mr-2 hover:bg-blue-600 transition duration-200"
                                            >
                                                الحصول على الموقع
                                            </button>
                                            <button
                                                onClick={() => fetchLocations(selectedDevice.uuid)}
                                                className="mt-2 bg-blue-500 text-white px-3 py-1 rounded-lg hover:bg-blue-600 transition duration-200"
                                            >
                                                تحديث المواقع
                                            </button>
                                            <div className="mt-2">
                                                {locations.length > 0 ? (
                                                    <div>
                                                        {locations.map((loc, index) => (
                                                            <p key={index} className="text-gray-400 mb-1">
                                                                {formatLocalTime(loc.captured_at)} - Lat: {loc.latitude}, Lon: {loc.longitude}
                                                                {loc.map_url && (
                                                                    <a href={loc.map_url} target="_blank" className="text-blue-400 ml-2">عرض على الخريطة</a>
                                                                )}
                                                            </p>
                                                        ))}
                                                    </div>
                                                ) : (
                                                    <p className="text-gray-400">لا توجد مواقع متاحة.</p>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                    <div className="bg-gray-800 shadow-md rounded-lg p-4 hover:bg-gray-700 mt-6 hud-effect">
                                        <h3 className="text-lg font-semibold text-blue-400">لقطات شاشة دورية</h3>
                                        <button
                                            onClick={() => fetchPeriodicScreenshots(selectedDevice.uuid)}
                                            className="mt-2 bg-blue-500 text-white px-3 py-1 rounded-lg hover:bg-blue-600 transition duration-200"
                                        >
                                            تحديث اللقطات الدورية
                                        </button>
                                        {periodicScreenshots.length > 0 ? (
                                            <div className="mt-2 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                                                {periodicScreenshots.map((screenshot, index) => (
                                                    <div key={index} className="text-gray-400">
                                                        <p>{formatLocalTime(screenshot.captured_at)}</p>
                                                        <img 
                                                            src={screenshot.screenshot_url} 
                                                            alt={`لقطة دورية في ${formatLocalTime(screenshot.captured_at)}`} 
                                                            className="mt-1 w-full h-auto rounded-lg shadow-md"
                                                            onError={(e) => { console.error('خطأ في تحميل اللقطة:', screenshot.screenshot_url); e.target.alt = 'فشل تحميل الصورة'; }}
                                                        />
                                                        <a href={screenshot.screenshot_url} target="_blank" className="text-blue-400 mt-1 inline-block">عرض الصورة</a>
                                                    </div>
                                                ))}
                                            </div>
                                        ) : (
                                            <p className="mt-2 text-gray-400">لا توجد لقطات شاشة دورية متاحة.</p>
                                        )}
                                    </div>
                                    <div className="bg-gray-800 shadow-md rounded-lg p-4 hover:bg-gray-700 mt-6 hud-effect">
                                        <h3 className="text-lg font-semibold text-blue-400">لقطات شاشة يدوية</h3>
                                        <button
                                            onClick={() => fetchScreenshots(selectedDevice.uuid)}
                                            className="mt-2 bg-blue-500 text-white px-3 py-1 rounded-lg hover:bg-blue-600 transition duration-200"
                                        >
                                            تحديث اللقطات اليدوية
                                        </button>
                                        {screenshots.length > 0 ? (
                                            <div className="mt-2 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                                                {screenshots.map((screenshot, index) => (
                                                    <div key={index} className="text-gray-400">
                                                        <p>{formatLocalTime(screenshot.captured_at)}</p>
                                                        <img 
                                                            src={screenshot.screenshot_url} 
                                                            alt={`لقطة يدوية في ${formatLocalTime(screenshot.captured_at)}`} 
                                                            className="mt-1 w-full h-auto rounded-lg shadow-md"
                                                            onError={(e) => { console.error('خطأ في تحميل اللقطة:', screenshot.screenshot_url); e.target.src = 'https://via.placeholder.com/300?text=فشل+تحميل+الصورة'; e.target.alt = 'فشل تحميل الصورة'; }}
                                                        />
                                                        <a href={screenshot.screenshot_url} target="_blank" className="text-blue-400 mt-1 inline-block">عرض الصورة</a>
                                                    </div>
                                                ))}
                                            </div>
                                        ) : (
                                            <p className="mt-2 text-gray-400">لا توجد لقطات شاشة يدوية متاحة.</p>
                                        )}
                                    </div>
                                    <div className="bg-gray-800 shadow-md rounded-lg p-4 hover:bg-gray-700 mt-6 hud-effect">
                                        <h3 className="text-lg font-semibold text-blue-400">التسجيلات الصوتية</h3>
                                        <button
                                            onClick={() => sendCommand("record_audio")}
                                            className="mt-2 bg-green-500 text-white px-3 py-1 rounded-lg hover:bg-green-600 transition duration-200"
                                        >
                                            تسجيل صوت
                                        </button>
                                        <button
                                            onClick={() => fetchAudioRecordings(selectedDevice.uuid)}
                                            className="mt-2 ml-2 bg-blue-500 text-white px-3 py-1 rounded-lg hover:bg-blue-600 transition duration-200"
                                        >
                                            تحديث التسجيلات
                                        </button>
                                        {audioRecordings.length > 0 ? (
                                            <div className="mt-2">
                                                {audioRecordings.map((recording, index) => (
                                                    <div key={index} className="text-gray-400 mb-2">
                                                        التسجيل في: {formatLocalTime(recording.timestamp)}
                                                        <audio controls className="mt-1 w-full">
                                                            <source src={recording.audio_url} type="audio/mp4" />
                                                            متصفحك لا يدعم عنصر الصوت.
                                                        </audio>
                                                        <a href={recording.audio_url} target="_blank" className="text-blue-400 ml-2">عرض</a>
                                                        <a href={recording.audio_url} download className="text-blue-400 ml-2">تنزيل</a>
                                                    </div>
                                                ))}
                                            </div>
                                        ) : (
                                            <p className="mt-2 text-gray-400">لا توجد تسجيلات صوتية متاحة.</p>
                                        )}
                                    </div>
                                    <div className="bg-gray-800 shadow-md rounded-lg p-6 mt-6 hud-effect">
                                        <h2 className="text-xl font-semibold text-blue-400 mb-2">إرسال الأوامر</h2>
                                        <button
                                            onClick={() => sendCommand("record_audio")}
                                            className="bg-green-500 text-white px-4 py-2 rounded-lg mr-2 hover:bg-green-600 transition duration-200"
                                        >
                                            تسجيل صوت
                                        </button>
                                        <button
                                            onClick={() => sendCommand("take_screenshot")}
                                            className="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition duration-200"
                                        >
                                            أخذ لقطة شاشة
                                        </button>
                                        <div className="mt-4">
                                            <p className="text-gray-400">نتائج الأوامر:</p>
                                            {commandResults['record_audio'] && (
                                                <p className="text-blue-400">
                                                    التسجيل الصوتي: <a href={commandResults['record_audio']} target="_blank">عرض التسجيل</a>
                                                </p>
                                            )}
                                            {commandResults['take_screenshot'] && (
                                                <p className="text-blue-400">
                                                    اللقطة: <a href={commandResults['take_screenshot']} target="_blank">عرض الصورة</a>
                                                </p>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            ) : (
                                <div className="bg-gray-800 shadow-md rounded-lg p-6 hud-effect">
                                    <h3 className="text-lg font-semibold text-blue-400 mb-4">إدارة المناطق المحيطة (Geofence)</h3>
                                    <div className="mb-4">
                                        <div className="geofence-map-container">
                                            <div ref={geofenceMapRef} className="w-full h-full rounded-lg overflow-hidden"></div>
                                            <select
        value={mapType}
        onChange={(e) => setMapType(e.target.value)}
        className="absolute top-2 left-2 p-2 border border-gray-600 rounded-lg bg-gray-700 text-white z-1000"
    >
        <option value="standard">خريطة قياسية</option>
        <option value="satellite">قمر صناعي</option>
    </select>
                                            <div className="geofence-info">
                                                <p>انقر على الخريطة لتحديد مركز المنطقة</p>
                                                <p className="mt-1">مركز: {geofenceSettings.latitude.toFixed(6)}, {geofenceSettings.longitude.toFixed(6)}</p>
                                            </div>
                                            <div className="geofence-legend">
                                                <div className="legend-item">
                                                    <span>موقع الجهاز</span>
                                                    <div className="legend-color bg-red-500"></div>
                                                </div>
                                                <div className="legend-item">
                                                    <span>المناطق المحيطة</span>
                                                    <div className="legend-color bg-yellow-500"></div>
                                                </div>
                                                <div className="legend-item">
                                                    <span>منطقة جديدة</span>
                                                    <div className="legend-color bg-cyan-500"></div>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="flex space-x-2 mt-4">
    <button
        className={`px-4 py-2 rounded ${drawnPolygon ? 'bg-green-600 hover:bg-green-700' : 'bg-gray-400 cursor-not-allowed'} text-white`}
        onClick={savePolygonGeofence}
        disabled={!drawnPolygon}
    >
        حفظ Polygon
    </button>
    <button
        className={`px-4 py-2 rounded ${drawnPolygon ? 'bg-red-600 hover:bg-red-700' : 'bg-gray-400 cursor-not-allowed'} text-white`}
        onClick={clearDrawnPolygon}
        disabled={!drawnPolygon}
    >
        مسح Polygon
    </button>
</div>

                                        <div className="flex flex-wrap items-center mt-4">
                                            <div className="w-full md:w-1/2 pr-2 mb-2">
                                                <label className="block text-gray-400 mb-1">اسم المنطقة</label>
                                                <input
                                                    type="text"
                                                    value={geofenceSettings.name}
                                                    onChange={(e) => setGeofenceSettings(prev => ({ ...prev, name: e.target.value }))}
                                                    className="w-full p-2 border border-gray-600 rounded-lg bg-gray-700 text-white"
                                                    placeholder="أدخل اسم المنطقة"
                                                />
                                            </div>
                                            <div className="w-full md:w-1/2 pl-2 mb-2">
                                                <label className="block text-gray-400 mb-1">نصف القطر (متر)</label>
                                                <input
                                                    type="number"
                                                    value={geofenceSettings.radius}
                                                    onChange={(e) => setGeofenceSettings(prev => ({ ...prev, radius: parseInt(e.target.value) || 500 }))}
                                                    className="w-full p-2 border border-gray-600 rounded-lg bg-gray-700 text-white"
                                                    min="100"
                                                    max="5000"
                                                />
                                            </div>
                                        </div>
                                        <button
                                            onClick={addGeofence}
                                            className="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition duration-200 w-full mt-2"
                                        >
                                            إضافة Geofence
                                        </button>
                                    </div>
                                    <div className="mt-6">
                                        <h4 className="text-md font-semibold text-blue-400 mb-2">المناطق المحيطة الحالية</h4>
                                        {geofences.length > 0 ? (
                                            <div className="overflow-x-auto">
                                                <table className="min-w-full bg-gray-700 border border-gray-600 rounded-lg">
                                                    <thead>
                                                        <tr className="bg-gray-600 border-b">
                                                            <th className="py-2 px-4 text-right text-gray-300 font-semibold">الاسم</th>
                                                            <th className="py-2 px-4 text-right text-gray-300 font-semibold">الإحداثيات</th>
                                                            <th className="py-2 px-4 text-right text-gray-300 font-semibold">نصف القطر (متر)</th>
                                                            <th className="py-2 px-4 text-right text-gray-300 font-semibold">الإجراءات</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {geofences.map((gf) => (
                                                            <tr key={gf.id} className="border-b hover:bg-gray-600 transition duration-200">
                                                                <td className="py-2 px-4 text-right">{gf.name}</td>
                                                                <td className="py-2 px-4 text-right">Lat {gf.latitude.toFixed(6)}, Lon {gf.longitude.toFixed(6)}</td>
                                                                <td className="py-2 px-4 text-right">{gf.radius}</td>
                                                                <td className="py-2 px-4 text-right">
                                                                    <button
                                                                        onClick={() => deleteGeofence(gf.id)}
                                                                        className="bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600 transition duration-200"
                                                                    >
                                                                        حذف
                                                                    </button>
                                                                </td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                        ) : (
                                            <p className="text-gray-400 text-center py-4">لا توجد مناطق محيطة مضافة لهذا الجهاز.</p>
                                        )}
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        };
        

        class ErrorBoundary extends React.Component {
    constructor(props) {
        super(props);
        this.state = { hasError: false, error: null };
    }

    static getDerivedStateFromError(error) {
        return { hasError: true, error };
    }

    render() {
        if (this.state.hasError) {
            return (
                <div className="text-red-500 p-4">
                    <h2>حدث خطأ</h2>
                    <p>{this.state.error?.message}</p>
                </div>
            );
        }
        return this.props.children;
    }
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(
    <ErrorBoundary>
        <App />
    </ErrorBoundary>
);
root.render(<App />);
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'95bf0e7b1e860c99',t:'MTc1MTk3MjIwMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
